name: CSW Sync

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: csw-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-slim

    permissions:
      actions: write
    steps:
      - uses: actions/checkout@v6

      - run: npm ci

      # sync.ts reads the current cursor from CSW_CURSOR, fetches one page
      # of CSW records, logs them to stderr, and prints the updated cursor
      # JSON to stdout. That output is stored back as a repository variable
      # so the next run can resume where this one left off.
      # If there are more records than fit in one page, the trickle workflow
      # is enabled to process the rest.
      - name: Run sync and update cursor
        run: |
          CURSOR=$(node src/sync.ts --max-pages 1)
          gh variable set CSW_CURSOR --body "$CURSOR"
          if echo "$CURSOR" | jq -e '.pending == null' > /dev/null; then
            gh workflow disable trickle.yml 2>/dev/null || true
          else
            gh workflow enable trickle.yml
          fi
        env:
          CSW_CURSOR: ${{ vars.CSW_CURSOR }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
