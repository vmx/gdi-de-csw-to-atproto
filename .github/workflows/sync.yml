name: CSW Sync

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: csw-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-slim

    permissions:
      # To make it work for private repos
      contents: read
    steps:
      - uses: actions/checkout@v6

      - run: npm ci

      # sync.ts reads the current cursor from CSW_CURSOR, fetches one page
      # of CSW records, logs them to stderr, and prints the updated cursor
      # JSON to stdout. That output is stored back as a repository variable
      # so the next run can resume where this one left off.
      # If there are more records than fit in one page, the trickle workflow
      # is enabled to process the rest.
      - name: Run sync and update cursor
        run: |
          CURSOR=$(node src/sync.ts --max-pages 1)
          gh variable list
          gh variable set CSW_CURSOR --body "${CURSOR}"
          gh workflow list

          WORKFLOW_STATE=$(gh workflow list --all --json path,state --jq '.[] | select(.path | endswith("trickle.yml")) | .state')

          if echo "${CURSOR}" | jq -e '.pending == null' > /dev/null; then
            if [ "${WORKFLOW_STATE}" = "active" ]; then
              echo "Disable trickle workflow"
              gh workflow disable trickle.yml
            else
              echo "Trickle workflow already disabled"
            fi
          else
            if [ "${WORKFLOW_STATE}" != "active" ]; then
              echo "Enable trickle workflow"
              gh workflow enable trickle.yml
            else
              echo "Trickle workflow already enabled"
            fi
          fi
        env:
          CSW_CURSOR: ${{ vars.CSW_CURSOR }}
          GH_TOKEN: ${{ secrets.TOKEN_FOR_GITHUB_ACTIONS }}
